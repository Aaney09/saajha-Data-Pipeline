config {
    type:"table",
    tags: "IE"
}


with mathProfile as (
  SELECT distinct 
    safe_cast(trim(urn, '+') as int64) as p_num, 
    safe_Cast(json_value(details,"$.parentid") as int64) as parentId,
    json_value(details,"$.opted_in")opted_in_status,
    json_value(details, "$.contentflowmaths")mathContentProfile,
    json_value(details, "$.contentflowhindi")hindiContentProfile,
    json_value(details,"$.lastworksheetsubject")lastsubject,
    json_value(details, "$.lastmathworksheetsent")lastsent,			
    datetime_Add(updated_At, interval 330 minute)updated_at_ist,			
    date(datetime_Add(updated_At, interval 330 minute)) profile_updated_date	,
    json_value(details, "$.hindilevel")hindi_level,
    json_value(details, "$.mathslevel")math_level,
    if(json_value(details, "$.lastmathworksheetsenton")<>"",
      datetime_add(datetime(left(json_value(details, "$.lastmathworksheetsenton"),19)) ,interval 330 minute),null) as lastmathsWorksheetSentOn,
    if(json_value(details, "$.lasthindiworksheetsenton")<>"",
      datetime_add(datetime(left(json_value(details, "$.lasthindiworksheetsenton"),19)) ,interval 330 minute),null) as lasthindiWorksheetSentOn				
FROM ${ref("911171817034_contacts")}	
qualify row_number() over(partition by urn,date(datetime_Add(updated_At, interval 330 minute))order by updated_at desc)=1
)	

,ongoing_opt_in as (select *
from mathProfile
where (mathContentProfile = "inprocess") and math_level<>"4" and opted_in_status = "true" and lastsubject = "maths" 
AND
date_diff(profile_updated_date,date(lasthindiWorksheetSentOn),day)=1
)

,worksheetTemp as (select phone_number,date(sent_at)worksheet_sent_date,error_code , error_reason , last_message_status

-- `dataform.hindiWorksheetSent`
from ${ref("IE_template_sent")}
where (template_name ="fln_worksheet" and lower(template_meta_data) like "%content_id=maths%" )

)

, assessment as (select distinct parentid,childid,date(assessmentDate)date_assessment,datetime(assessmentDate)assessmentDate
from ${ref("assessment_data")}
)

,whom_worksheet_should_go as (
select distinct o.p_num,profile_updated_date,o.parentid,
from ongoing_opt_in o
left join assessment a
on o.parentid = a.parentid and o.profile_updated_date= a.date_assessment
where a.parentid is null)

,_2nd_Set as (
  select distinct o.p_num,profile_updated_date,o.parentid
from ongoing_opt_in o
inner join assessment a
on o.parentid = a.parentid and o.profile_updated_date= a.date_assessment
where lastmathsWorksheetSentOn<assessmentDate
)

,whom_worksheet_should_go_overall as (
  select *
  from whom_worksheet_should_go
  union distinct
  select *
  from _2nd_Set
)
, failed_numbers as (
  select
  profile_updated_date,
  -- ifnull(safe_cast(ie_main.cohort as string),"unknown") as cohort,
  s.p_num,
  if(phone_number is null or last_message_status ="failed","fail","success") as status_last_two_worksheet,
   ROW_NUMBER() OVER (PARTITION BY p_num ORDER BY profile_updated_date) AS attempt_no

  from whom_worksheet_should_go_overall s
  left join worksheetTemp w	
on p_num=phone_number and s.profile_updated_date = w.worksheet_sent_date	
left join ${ref("ie_general_activity")} ie_gen
on ie_gen.phone_numbers_to_be_sent=s.p_num
and date(ie_gen.general_activity_date)=s.profile_updated_date
-- left join   `saajhadata.dataform.impact_evaluation_main_data` ie_main
-- on ie_main.ParentMobileMain=s.p_num

  where 
   ie_gen.phone_numbers_to_be_sent is null and p_num <>918527647594
  
)
,prev_dates as (
  select
  profile_updated_date,
  -- cohort,
  p_num,
  status_last_two_worksheet,
  LAG(status_last_two_worksheet, 1) OVER (PARTITION BY p_num ORDER BY profile_updated_date) AS prev_day,
  -- LAG(profile_updated_date, 2) OVER (PARTITION BY p_num ORDER BY profile_updated_date) AS prev2_day
  from failed_numbers
)
, three_failures as (
  select
  profile_updated_date as second_failure_Date,
  -- cohort,
  p_num as phone_number_two_failures
  from prev_dates
  WHERE 
 status_last_two_worksheet='fail'
 and prev_day='fail'
 -- DATE_DIFF(profile_updated_date, prev_day, DAY) = 1
  -- AND DATE_DIFF(prev_day, prev2_day, DAY) = 1
)

,overall_worksheet_status as 
(select 
distinct profile_updated_date,
ifnull(safe_cast(ie_main.cohort as string),"unknown") as cohort,
      count(distinct p_num)whommathWorksheetHasToProcessFromTurn,
      count(distinct if(phone_number is not null,p_num,null)) as whom_math_worksheet_has_processed_from_turn,
      count(distinct if(phone_number is null	,p_num,null)) whom_math_worksheet_has_not_processed_from_turn,
      count(distinct phone_number_two_failures ) as two_failures_math,
      round(
      count(distinct if(phone_number is null	,p_num,null))/count(distinct p_num)*100
        ,2
      ) math_turn_failure_rate,
      count(distinct if(last_message_status ="failed",p_num,null)) as math_worksheet_meta_failed,
      if(count(distinct if(phone_number is not null	,p_num,null))<>0,
      round(count(distinct if(last_message_status ="failed",p_num,null))/count(distinct if(phone_number is not null	,p_num,null)) * 100
      ,2)
      ,null) math_meta_failure_rate,
      count(distinct if(error_code="131050",p_num,null)) as mathWorksheetError_131050_User_has_stopped_reciept_of_marketing_messages,
      count(distinct if(error_code="131049",p_num,null)) as mathWorksheetError_131049_Meta_chose_not_to_deliver,
      count(distinct if(error_code="131026",p_num,null)) as mathWorksheetError_131026_Message_Undeliverable,
      count(distinct if(error_code="131000",p_num,null)) as mathWorksheetError_131000_Something_went_wrong,
      count(distinct if(error_code="130472",p_num,null)) as mathWorksheetError_130472_User_number_is_part_of_an_experiment,
from whom_worksheet_should_go_overall s	
left join worksheetTemp w	
on p_num=phone_number and s.profile_updated_date = w.worksheet_sent_date


left join `impact_evaluation.GENERAL_ACTIVITY_DASHBOARD_PILOT` ie_gen
on ie_gen.phone_numbers_to_be_sent=s.p_num
and date(ie_gen.general_activity_date)=s.profile_updated_date

left join   ${ref("impact_evaluation_main_data")} ie_main
on ie_main.ParentMobileMain=s.p_num


left join three_failures three_f
on three_f.second_failure_date=s.profile_updated_date 
and three_f.phone_number_two_failures=s.p_num

where ie_gen.phone_numbers_to_be_sent is null
and p_num <>918527647594

group by 1,2

)


select distinct *
from overall_worksheet_status 
-- order by p_num,updated_at_ist
order by 1 desc