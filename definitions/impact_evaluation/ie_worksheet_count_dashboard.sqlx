config {
    type: "table",
    tags: ["IE"]
}
with Worksheet_Sent AS (
  SELECT 
    Distinct worksheetNumber AS Worksheet, 
    phone_number , 
    LevelNumber AS Level, 
    monthNumber AS Month,
    hindi_assessment_name AS HindiAssessedName,
    math_assessment_name AS MathAssessedName,
    date(hindi_assessment_date) AS HindiAssessedDate,
    date(math_assessment_date) AS MathAssessedDate ,
    sent_at,
  FROM ${ref("IE_hindi_worksheet_sent")} s 
  WHERE DATE(sent_at) >'2025-09-01'
  and last_message_status not like 'failed'

),
Worksheet_Clicked AS (
  SELECT 
    Distinct worksheetNumber AS Worksheet, 
    phone_number ,
    clicked_time,
    LevelNumber AS Level, 
    monthNumber AS Month,
    hindi_assessment AS HindiAssessedName,
    maths_assessment AS MathAssessedName,
    Date(hindi_assessment_date) AS HindiAssessedDate,
    Date(maths_assessment_date) AS MathAssessedDate,
    -- origin as origin_clicked
  FROM ${ref("IE_worksheet_clicked")}
  WHERE DATE(clicked_time) > "2025-09-01"
  and subject ='hindi' and worksheet_clicked_link_source  like 'whatsapp'
),
Worksheet_Completed AS (
  SELECT 
    Distinct worksheetNumber AS Worksheet, 
    phone_number ,
    worksheet_completed_time as  submitted_time,
    LevelNumber AS Level, 
    monthNumber AS Month,
    -- hindi_assessment AS HindiAssessedName,
    -- maths_assessment AS MathAssessedName,
    date(hindi_assessment_date) AS HindiAssessedDate,
    date(maths_assessment_date) AS MathAssessedDate,
    -- origin as origin_completed
  FROM ${ref("IE_hindi_worksheet_completed")} 
  WHERE DATE(worksheet_completed_time) >'2025-09-01'
  and worksheet_submitted_source like 'WHATSAPP'
)

,hindi_ as (SELECT rosterparentId,ws.Level,ws.month,WS.sent_at, WS.Worksheet,clicked_time,submitted_time, WS.phone_number ,WC.phone_number as clickedBy, TQ.phone_number as completedBy
  -- Distinct WS.Worksheet,
  -- COUNT(DISTINCT WS.phone_number) AS Sent,
  -- COUNT(DISTINCT WC.phone_number) AS Clicked,
  -- COUNT(DISTINCT TQ.phone_number) AS Completed
FROM
  Worksheet_Sent WS
inner join `dataform.allPhoneNumberWithPid`
on WS.Phone_number=number
-- inner join final_assessed_data fa
-- on fa.parentid=rosterparentId
LEFT JOIN
  Worksheet_Clicked WC ON WS.phone_number = WC.phone_number AND
  WS.Worksheet = WC.Worksheet
  AND WS.Level = WC.Level
  AND WS.Month = WC.Month
  AND WS.HindiAssessedDate = WC.HindiAssessedDate
  AND WS.MathAssessedDate = WC.MathAssessedDate
LEFT JOIN
  Worksheet_Completed TQ ON WC.phone_number = TQ.phone_number AND
  WC.Worksheet = TQ.Worksheet
  AND WC.Level = TQ.Level
  AND WC.Month = TQ.Month
  AND WC.HindiAssessedDate = TQ.HindiAssessedDate
  AND WC.MathAssessedDate = TQ.MathAssessedDate
)

,main_ as (select distinct h.*,ie.Cohort

from hindi_ h
inner join ${ref("impact_evaluation_main_data")} ie
on h.rosterparentid=ie.parentid

)

,cte as (
select 
rosterparentid,
date(sent_at) as sent_At,
cohort,
-- origin_clicked,
-- origin_completed,
-- month,
-- fa.*,
level,
worksheet,
count(distinct phone_number) as UniqueUserSentTo, 
count(distinct clickedBy)UniqueUserclickedBy,
count(distinct completedBy)uniqueUserCompletedBy

from main_ m

group by all
),
level_wise_count as(
  select
  -- rosterparentid as parent_id_hindi,
  sent_At,
  cohort,
--   origin_clicked,
-- origin_completed,
  -- level level_hindi_worksheet,
  sum(if(UniqueUserSentTo>1,1,UniqueUserSentTo)) as total_worksheet_sent_hindi,
  sum(if(UniqueUserclickedBy>1,1,UniqueUserclickedBy)) as  total_worksheet_clicked_hindi,
  sum(if(uniqueUserCompletedBy>1,1,uniqueUserCompletedBy)) as total_woorksheet_completeed_hindi
  from cte
  group by all
)
-----------------------------------------------------------------------------------------
-- MATH WORKSHEET
-----------------------------------------------------------------------------------------
, Worksheet_Sent_math AS (
  SELECT 
    Distinct worksheetNumber AS Worksheet, 
    phone_number , 
    LevelNumber AS Level, 
    monthNumber AS Month,
    hindi_assessment_name AS HindiAssessedName,
    math_assessment_name AS MathAssessedName,
    date(hindi_assessment_date) AS HindiAssessedDate,
    date(math_assessment_date) AS MathAssessedDate ,
    sent_at,
  FROM ${ref("IE_math_worksheet_sent")} s 
  
  WHERE DATE(sent_at)  >'2025-09-01'
  and last_message_status not like 'failed'

),
Worksheet_Clicked_math AS (
  SELECT 
    Distinct worksheetNumber AS Worksheet, 
    phone_number ,
    clicked_time,
    LevelNumber AS Level, 
    monthNumber AS Month,
    hindi_assessment AS HindiAssessedName,
    maths_assessment AS MathAssessedName,
    Date(hindi_assessment_date) AS HindiAssessedDate,
    Date(maths_assessment_date) AS MathAssessedDate,
    -- origin as origin_clicked
    
  FROM ${ref("IE_worksheet_clicked")} 
  WHERE DATE(clicked_time) >'2025-09-01'
  and subject='math'
  and lower(worksheet_clicked_link_source)  like 'whatsapp'
),
Worksheet_Completed_math AS (
  SELECT 
    Distinct worksheetNumber AS Worksheet, 
    phone_number ,
    worksheet_completed_time as  submitted_time,
    LevelNumber AS Level, 
    monthNumber AS Month,
    -- hindi_assessment AS HindiAssessedName,
    -- maths_assessment AS MathAssessedName,
    date(hindi_assessment_date) AS HindiAssessedDate,
    date(maths_assessment_date) AS MathAssessedDate,
    -- origin as origin_completed
  FROM ${ref("IE_math_worksheet_completed")} 
  WHERE DATE(worksheet_completed_time) >'2025-09-01'
  and  lower(worksheet_submitted_source)  like 'whatsapp'
)

,math_ as (SELECT rosterparentId,ws.Level,ws.month,WS.sent_at, WS.Worksheet,clicked_time,submitted_time, WS.phone_number ,WC.phone_number as clickedBy, TQ.phone_number as completedBy

FROM
  Worksheet_Sent_math WS
inner join `dataform.allPhoneNumberWithPid`
on WS.Phone_number=number
LEFT JOIN
  Worksheet_Clicked_math WC ON WS.phone_number = WC.phone_number AND
  WS.Worksheet = WC.Worksheet
  AND WS.Level = WC.Level
  AND WS.Month = WC.Month
  AND WS.HindiAssessedDate = WC.HindiAssessedDate
  AND WS.MathAssessedDate = WC.MathAssessedDate
LEFT JOIN
  Worksheet_Completed_math TQ ON WC.phone_number = TQ.phone_number AND
  WC.Worksheet = TQ.Worksheet
  AND WC.Level = TQ.Level
  AND WC.Month = TQ.Month
  AND WC.HindiAssessedDate = TQ.HindiAssessedDate
  AND WC.MathAssessedDate = TQ.MathAssessedDate

)

,main_math as (select distinct m.*, ie.cohort

from math_ m
inner join ${ref("impact_evaluation_main_data")} ie
on ie.parentid=m.rosterparentid
)
,cte_math as (
select 
rosterparentid,
date(sent_at) as sent_At,
cohort,
-- origin_clicked,
-- origin_completed,
-- month,
-- fa.*,
level,
worksheet,
count(distinct phone_number) as UniqueUserSentTo, 
count(distinct clickedBy)UniqueUserclickedBy,
count(distinct completedBy)uniqueUserCompletedBy

from main_math m
group by all
),
level_wise_count_math as(
  select
  -- rosterparentid as parent_id_math,
  sent_At,
  cohort,
--   origin_clicked,
-- origin_completed,
  -- level as level_math_worksheet,
  sum(if(UniqueUserSentTo>1,1,UniqueUserSentTo)) as total_worksheet_sent_math,
  sum(if(UniqueUserclickedBy>1,1,UniqueUserclickedBy)) as total_worksheet_clicked_math,
  sum(if(uniqueUserCompletedBy>1,1,uniqueUserCompletedBy)) as total_worksheet_completed_math
  from cte_math
  group by all
)
---------------------------
-- kam command
----------------------------
,  kam_command as (
  select
  distinct
  userid as parentid,
  phone_number,
  date(sent_at) as sent_at,
  extract(month from sent_at) as month,
  cohort
  from ${ref("IE_template_sent")} ts
  inner join ${ref("User")} u
on safe_cast(concat("91",UserLogin) as int64) = phone_number
  inner join ${ref("impact_evaluation_main_data")} ie
  on u.userid=ie.parentid
  where flow_name like 'Kam Command'
  and last_message_status not like 'failed'
  and date(sent_at)>='2025-09-01'
)
, kam_total_Sent as (
select
sent_date,
cohort,
count(distinct parentid) *15 as total_sent_worksheet
from (
select
parentid,
cohort,
month,
min(sent_at) as sent_date
from kam_command
group by all
)
group by all
)
---------------------------------------
-- other then whatspp click
----------------------------------------
, website_clicks as (
  SELECT 
    Distinct worksheetNumber AS Worksheet, 
    phone_number ,
    c.parentid,
    cohort,
    clicked_time,
    LevelNumber AS Level, 
    worksheetNumber,
    monthNumber AS Month,
    -- hindi_assessment AS HindiAssessedName,
    -- maths_assessment AS MathAssessedName,
    -- Date(hindi_assessment_date) AS HindiAssessedDate,
    -- Date(maths_assessment_date) AS MathAssessedDate,
    subject,
    case when origin is null then 'whatsapp'
    when lower(origin) like 'cmd' then 'KAM'
    else origin end as origin 
  FROM ${ref("IE_worksheet_clicked")} c
  inner join ${ref("impact_evaluation_main_data")} ie
  on c.parentid=ie.parentid
  WHERE DATE(clicked_time) > "2025-09-01"
  -- and subject ='hindi' 
  and worksheet_clicked_link_source  not like 'whatsapp'
)
, website_hindi_click as (
  select
  clicked_date,
  ORIGIN,
  cohort,
  sum(total_worksheet_clicked_hindi) as website_click_hindi
  from (
  select
  date(clicked_time) as clicked_date,
  worksheetnumber,
  ORIGIN,
  cohort,
  count(distinct parentid) as total_worksheet_clicked_hindi
  
  from website_clicks 
  where subject like 'hindi'
  group by all)
  group by all

)
, website_math_click as (
  select 
  clicked_date,
  ORIGIN,
  cohort,
  sum(total_worksheet_clicked_hindi) as website_clicked_math
  from (
  select
  date(clicked_time) as clicked_date,
  worksheetnumber,
  ORIGIN,
  cohort,
  count(distinct parentid) as total_worksheet_clicked_hindi
  
  from website_clicks
  where subject like 'math'
  group by all
  )
  group by all
)

-----------------------------
-- Other then whatsapp submits
---------------------------------
, math_submit_webiste as ( 
   SELECT 
    Distinct worksheetNumber AS Worksheet, 
    phone_number ,
    c.parentid,
    ie.cohort,
    worksheet_completed_time as  submitted_time,
    worksheetNumber,
    LevelNumber AS Level, 
    monthNumber AS Month,
    -- hindi_assessment AS HindiAssessedName,
    -- maths_assessment AS MathAssessedName,
    date(hindi_assessment_date) AS HindiAssessedDate,
    date(maths_assessment_date) AS MathAssessedDate,
        case when origin is null then 'whatsapp'
    when lower(origin) like 'cmd' then 'KAM'
    else origin end as origin
  FROM ${ref("IE_math_worksheet_completed")} c
  inner join ${ref("impact_evaluation_main_data")} ie
  on c.parentid=ie.parentid
  WHERE DATE(worksheet_completed_time) >'2025-09-01'
  and  lower(worksheet_submitted_source)  not like 'whatsapp'
)
,
wesite_math_submit_count as (
  select 
  submitted_date,
  ORIGIN,
  cohort,
  sum(unique_parentid) as total_worksheet_math_website_submitted
  from (
  select
  date(submitted_time) as submitted_date,
  worksheetnumber,
  ORIGIN,
  cohort,
  count(distinct parentid) as unique_parentid
  from math_submit_webiste
  group by all)
  group by all
)

, hindi_submit_webiste as ( 
   SELECT 
    Distinct worksheetNumber AS Worksheet, 
    phone_number ,
    c.parentid,
    cohort,
    worksheet_completed_time as  submitted_time,
    worksheetNumber,
    LevelNumber AS Level, 
    monthNumber AS Month,
    -- hindi_assessment AS HindiAssessedName,
    -- maths_assessment AS MathAssessedName,
    date(hindi_assessment_date) AS HindiAssessedDate,
    date(maths_assessment_date) AS MathAssessedDate,
        case when origin is null then 'whatsapp'
    when lower(origin) like 'cmd' then 'KAM'
    else origin end as origin
  FROM ${ref("IE_hindi_worksheet_completed")} c 
    inner join ${ref("impact_evaluation_main_data")} ie
  on c.parentid=ie.parentid
  WHERE DATE(worksheet_completed_time) >'2025-09-01'
  and  lower(worksheet_submitted_source)  not like 'whatsapp'
)
,
wesite_hindi_submit_count as (
  select 
  submitted_date,
  ORIGIN,
  cohort,
  sum(unique_parentid) as total_worksheet_hindi_website_submitted
  from (
  select
  date(submitted_time) as submitted_date,
  worksheetnumber,
  ORIGIN,
  cohort,
  count(distinct parentid) as unique_parentid
  from hindi_submit_webiste
  group by all)
  group by all
)

-- select * from website_math_click
-- , getting_unique_counts_math as (
-- select 
-- from level_wise_count_math


-- )
-- ,
-- all_parentid as (
--   select parent_id_math as parentid
--   from level_wise_count_math
--   union distinct
--   select parent_id_hindi
--   from level_wise_count

-- )



--------------------------------------------------------------------------------------------------------------
-- select
-- * except(parent_id_hindi,parent_id_math)
-- from all_parentid fa
-------------------------------------------------------
/* WP SENT*/
-------------------------------------------------------
select sent_At,
total_worksheet_sent_hindi as total_worksheet_sent,
lc.total_worksheet_clicked_hindi as total_worksheet_clicked,
lc.total_woorksheet_completeed_hindi as total_worksheet_completed,
cohort,
'hindi' as subject, 
'whatsapp' as source_table
from level_wise_count lc 

union all

select 
sent_at,
lcm.total_worksheet_sent_math,
lcm.total_worksheet_clicked_math,
lcm.total_worksheet_completed_math,
cohort,
'math' as subject,
'whatsapp' as source_table
from LEVEL_wISE_COUNT_MATH lcm

union all
------------------------------------------------
-- KAM COMMAND SENT
----------------------------------------------
select
sent_date,
total_sent_worksheet,
-- count(distinct parentid)*15 as unique_id,
null,
null,
cohort,
'hindi' as subject,
'KAM' as source_table

from kam_total_Sent
-- group by all

union all



select
sent_date,
total_sent_worksheet,
-- count(distinct parentid)*15 as unique_id,
null,
null,
cohort,
'math' as subject,
'KAM' as source_table

from kam_total_Sent
group by all


union all
------------------------------------
--WEBSITE CLICK
--------------------------------------
select 
clicked_date,
null,
website_clicked_math,
null,
cohort,
'math' as subject,
ORIGIN as source_table
from website_math_click

union all

select 
clicked_date,
null,
website_click_hindi,
null,
cohort,
'hindi' as subject,
ORIGIN as source_table
from website_hindi_click

union all
------------------------------------------
-- WEBSITE SUBMIT
----------------------------------------
select
submitted_date,
null,
null,
total_worksheet_math_website_submitted,
cohort,
'math' as subject,
ORIGIN as source_table
from wesite_math_submit_count

union all


select
submitted_date,
null,
null,
total_worksheet_hindi_website_submitted,
cohort,
'hindi' as subject,
ORIGIN as source_table
from wesite_hindi_submit_count

order by 1,5
-- on fa.parentid=lcm.parent_id_math