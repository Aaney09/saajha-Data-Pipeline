config {
    type: "table",
    tags: ["IE"]
}
WITH general_activity_raw  AS (
  SELECT 
    COALESCE(phone_numbers_successfully_sent, sent_successfully_second_time) AS successfully_general_activity_numbers,
    general_activity_date,
    `group` as arm,
    Cohort,
    ROW_NUMBER() OVER (
      PARTITION BY COALESCE(phone_numbers_successfully_sent, sent_successfully_second_time) 
      ORDER BY general_activity_date
    ) AS rn
  FROM ${ref("ie_general_activity")}
)
, pulse_general_activity_treatment as (
select 
cohort,
"General Activity (Treatment)" as source_table,
count(distinct if(rn=1,successfully_general_activity_numbers,null)) as interaction_1,
count(distinct if(rn=2,successfully_general_activity_numbers,null)) as interaction_2,
count(distinct if(rn=3,successfully_general_activity_numbers,null)) as interaction_3,
count(distinct if(rn=4,successfully_general_activity_numbers,null)) as interaction_4,
count(distinct if(rn=5,successfully_general_activity_numbers,null)) as interaction_5,
count(distinct if(rn=5,successfully_general_activity_numbers,null)) as interaction_6
from general_activity_raw
where lower(arm)='treatment'
group by 1
)

, pulse_general_activity_control as (
select 
cohort,
"General Activity (Control)" as source_table,
count(distinct if(rn=1,successfully_general_activity_numbers,null)) as interaction_1,
count(distinct if(rn=2,successfully_general_activity_numbers,null)) as interaction_2,
count(distinct if(rn=3,successfully_general_activity_numbers,null)) as interaction_3,
count(distinct if(rn=4,successfully_general_activity_numbers,null)) as interaction_4,
count(distinct if(rn=5,successfully_general_activity_numbers,null)) as interaction_5,
count(distinct if(rn=5,successfully_general_activity_numbers,null)) as interaction_6
from general_activity_raw
where lower(arm)='control'
group by 1
)
-------------------------------------------------------------------------------------------
-- CALL RESOLVE
--------------------------------------------------------------------------------------------
, resolves as (select distinct ParentId,childId,Round,cohort
from ${ref("roster")} R
Inner join ${ref("impact_evaluation_main_data")}
using(parentid,childid)
where FeedbackType like "%RESOLVED%" and date(CallStartDateTime) between "2025-04-01" and "2028-03-31"
and R.ProjectId=1103935
--and agentMobile in (9555489577,7303046353,9582377226)
)

,year_2025_26_resolved as (
  select distinct *, row_number()over(partition by parentid,childid order by round Asc) as rounds_since_april_2025
  from resolves
)
, pulse_call_reslove as (
select distinct 
cohort,
"Call Resolve" as source_table,
 count(distinct if(rounds_since_april_2025=1,parentid,null)) as first_round,
 count(distinct if(rounds_since_april_2025=2,parentid,null)) as second_round,
 count(distinct if(rounds_since_april_2025=3,parentid,null)) as third_round,
 count(distinct if(rounds_since_april_2025=4,parentid,null)) as fourth_round,
 count(distinct if(rounds_since_april_2025=5,parentid,null)) as fifth_round,
 count(distinct if(rounds_since_april_2025=6,parentid,null)) as sixth_round,
--  count(distinct if(rounds_since_april_2025=7,parentid,null)) as seventh_round
from year_2025_26_resolved
group by all
)

----------------------------------------------------------
-- RESULT SHARED
--------------------------------------------------------

, allNumbersPIDtemplatesent as (
  select distinct 
  phone_number,
  rosterparentid as parentid,
  sent_at,
  date(sent_at)sent_date,
  last_message_status,
  -- ROW_NUMBER() OVER(PARTITION BY rosterparentId ORDER BY DATE(SENT_AT)) AS RN
  from ${ref("allPhoneNumberWithPid")} p
  inner join (select * from ${ref("IE_template_sent")} where last_message_status not like 'failed') ts
  on number = phone_number
  inner join  ${ref("IE")} ie
  on p.rosterparentid=ie.OnBoardedUserId
  where number is not null
  and ie.projectid=1103935
  and date(sent_at)>="2025-04-01"
  -- and rosterparentid=2033918
  AND  (template_name like "%fln_result_v2%" or template_name like "%fln_highest_level_v2%")
  qualify row_number() over(partition by rosterparentid, date(sent_at) order by Sent_At desc)=1
)
, lag_dates as (
  select 
  parentid,
  sent_date,
  lag(sent_date) over(partition by parentid order by sent_date) as resultlagdate
  from allNumbersPIDtemplatesent
  order by parentid asc, sent_date asc,resultlagdate asc
)

,resultData as ((select *,if(resultlagdate is null, 0,date_diff(sent_date,resultlagdate,day)) resultdateDifference,
from lag_dates
where if(resultlagdate is null, 0,date_diff(sent_date,resultlagdate,day))=0)

UNION ALL
(select *,if(resultlagdate is null, 0,date_diff(sent_date,resultlagdate,day)) resultdateDifference,
from lag_dates
where if(resultlagdate is null, 0,date_diff(sent_date,resultlagdate,day))>=25)
order by parentid  desc)


 ,result as (select *, row_number() over(partition by parentid order by sent_date asc)rn
from resultData
order by parentid asc,rn asc)



, pulse_result_shared as (
Select 
cohort,
"Result Shared" as source_table,
count(distinct if(rn=1,a.parentid,null)) as round_1_result,
count(distinct if(rn=2,a.parentid,null)) as round_2_result,
count(distinct if(rn=3,a.parentid,null)) as round_3_result,
count(distinct if(rn=4,a.parentid,null)) as round_4_result,
count(distinct if(rn=5,a.parentid,null)) as round_5_result,
count(distinct if(rn=6,a.parentid,null)) as round_6_result
-- count(distinct if(rn=7,a.parentid,null)) as round_7_result
from result a
left join ${ref("impact_evaluation_main_data")} ie_main
on a.parentid=ie_main.parentid
-- where last_message_status not like 'failed'
group by 1
)
-----------------------------------------------------------------------------
-- HINDI FIRST WORKSHEET
------------------------------------------------------------------------------




, 
hindi_assessment as (select distinct AssesseeActorId,Date(AssessmentTakenOn)dateOfAssessment,if(Level= "BEGINNER",0,safe_cast(regexp_extract(Level,r'\d') as int64)) as hindiLevel
from ${ref("assessment")}
where QuestionText like "%Ask%" and AssessmentId<>6
qualify row_number() over(partition by AssesseeActorId,date(AssessmentTakenOn) order by AssessmentTakenOn desc)=1
)
, math_assessment as (select distinct AssesseeActorId,Date(AssessmentTakenOn)dateOfAssessment, if(Level= "BEGINNER",0,safe_cast(regexp_extract(Level,r'\d') as int64)) as mathlevel
from ${ref("assessment")}
where QuestionText not like  "%Ask%" and AssessmentId <> 6
qualify row_number() over(partition by AssesseeActorId,date(AssessmentTakenOn) order by AssessmentTakenOn desc)=1
)

, childDetails as (select 
distinct 
IEId as childid, OnBoardedUserId as parentid,ProjectId as ProjectId,
safe_cast(regexp_extract(Education,r'\d+') as int64)as childClass,Education
from ${ref("IE")}
where  projectid=1103935
)

, assessments as (
  select *, dateOfAssessment+1 as hindi_content_to_send_on,dateOfAssessment+2 as math_content_to_send_on,
  case  
when c.childClass = 1 and mathLevel>=2 then TRUE
when c.childClass = 2 and mathLevel>=3 then TRUE
when c.childClass >=3 and mathLevel>=4 then TRUE
Else false
end mathFLnAchievedClassWise,
case  
when c.childClass = 1 and hindiLevel>=3 then TRUE
when c.childClass >=2 and hindiLevel>=4 then TRUE
Else false
end hindiFLnAchievedClassWise
from hindi_assessment h
inner join math_assessment m
using(assesseeActorID,dateOfAssessment)
inner join childDetails c
on assesseeActorID=childid)

-----------------------------------------------------
-- GETING HIGHEST LEVEL COUNT
----------------------------------------------------
, highest_level_roundwise as (
  select
  m.cohort,
  a.childid,
  row_number() over(partition by a.childid order by dateOfAssessment) as rn,
  mathFLnAchievedClassWise,
  hindiFLnAchievedClassWise
  from assessments a
  inner join ${ref("impact_evaluation_main_data")} m
  on a.childid=m.childid
)
,pulse_highest_level_math as (
  select
  cohort,
  "Highest Level Math" as source_table,
  count(distinct if(rn=1,childid,null)) as round_1_result,
count(distinct if(rn=2,childid,null)) as round_2_result,
count(distinct if(rn=3,childid,null)) as round_3_result,
count(distinct if(rn=4,childid,null)) as round_4_result,
count(distinct if(rn=5,childid,null)) as round_5_result,
count(distinct if(rn=6,childid,null)) as round_6_result
  from highest_level_roundwise
  where mathFLnAchievedClassWise is true
  group by all
)
,pulse_highest_level_hindi as (
  select
  cohort,
  "Highest Level Hindi" as source_table,
  count(distinct if(rn=1,childid,null)) as round_1_result,
count(distinct if(rn=2,childid,null)) as round_2_result,
count(distinct if(rn=3,childid,null)) as round_3_result,
count(distinct if(rn=4,childid,null)) as round_4_result,
count(distinct if(rn=5,childid,null)) as round_5_result,
count(distinct if(rn=6,childid,null)) as round_6_result
  from highest_level_roundwise
  where hindiFLnAchievedClassWise is true
  group by all
)
------------------------------------------------------------------------------



, hindi_first_worksheet_raw as (
 select distinct ws.parentid,
 ws.childid,
  phone_number,
  date(sent_at) as sent_date,
  last_message_status 
  from ${ref("IE_hindi_worksheet_sent")} ws
  inner join assessments a 
  on a.parentid=ws.parentid
  and date(ws.sent_At) between a.hindi_content_to_send_on and date_add(hindi_content_to_send_on,interval 2 day)
  -- inner join `platform_commons.IE` ie
  -- on ie.ieid=ws.childid
  -- inner join ${ref("impact_evaluation_main_data")} ie_main
  -- on ie_main.parentid=ws.parentid

  where worksheetNumber =1 
  and last_message_status not like 'failed'
  and projectid=1103935
  -- and date(sent_at)>'2025-09-10'
  and ws.parentid is not null
  qualify row_number() over(partition by ws.parentid ,date(sent_at) order by sent_at desc )=1
)
, lag_dates_hindi as (
  select 
  parentid,
  sent_date,
  lag(sent_date) over(partition by parentid order by sent_date) as hindilagdate
  from hindi_first_worksheet_raw
  order by parentid asc, sent_date asc,hindilagdate asc
)

,hindiData as ((select *,if(hindilagdate is null, 0,date_diff(sent_date,hindilagdate,day)) hindi_date_difference,
from lag_dates_hindi
where if(hindilagdate is null, 0,date_diff(sent_date,hindilagdate,day))=0)

UNION ALL
(select *,if(hindilagdate is null, 0,date_diff(sent_date,hindilagdate,day)) hindi_date_difference,
from lag_dates_hindi
where if(hindilagdate is null, 0,date_diff(sent_date,hindilagdate,day))>=25)
order by parentid  desc)


 ,hindi_worksheet as (select *, row_number() over(partition by parentid order by sent_date asc)rn
from hindiData
order by parentid asc,rn asc)



, pulse_hindi as (
Select 
cohort,
"Hindi 1st Worksheet" as tables,
count(distinct if(rn=1,a.parentid,null)) as round_1_result,
count(distinct if(rn=2,a.parentid,null)) as round_2_result,
count(distinct if(rn=3,a.parentid,null)) as round_3_result,
count(distinct if(rn=4,a.parentid,null)) as round_4_result,
count(distinct if(rn=5,a.parentid,null)) as round_5_result,
count(distinct if(rn=6,a.parentid,null)) as round_6_result
-- count(distinct if(rn=7,a.parentid,null)) as round_7_result
from hindi_worksheet a
inner join ${ref("impact_evaluation_main_data")} ie_main
on a.parentid=ie_main.parentid
-- where last_message_status not like 'failed'
group by 1
)



-----------------------------------------------------------------
-- math first worksheet
-----------------------------------------------------------------

, math_first_worksheet_raw as (
 select distinct ws.parentid,
 ws.childid,
  phone_number,
  date(sent_at) as sent_date,
  last_message_status 
  from ${ref("IE_math_worksheet_sent")} ws
  inner join assessments a 
  on a.parentid=ws.parentid
  and date(ws.sent_At) between a.math_content_to_send_on and date_add(math_content_to_send_on,interval 2 day)
  -- inner join `platform_commons.IE` ie
  -- on ie.ieid=ws.childid
  -- inner join ${ref("impact_evaluation_main_data")} ie_main
  -- on ie_main.parentid=ws.parentid

  where worksheetNumber =1 
  and last_message_status not like 'failed'
  and projectid=1103935
  -- and date(sent_at)>'2025-09-10'
  and ws.parentid is not null
  qualify row_number() over(partition by ws.parentid ,date(sent_at) order by sent_at desc )=1
)
, lag_dates_math as (
  select 
  parentid,
  sent_date,
  lag(sent_date) over(partition by parentid order by sent_date) as mathlagdate
  from math_first_worksheet_raw
  order by parentid asc, sent_date asc,mathlagdate asc
)

,mathdata as ((select *,if(mathlagdate is null, 0,date_diff(sent_date,mathlagdate,day)) hindi_date_difference,
from lag_dates_math
where if(mathlagdate is null, 0,date_diff(sent_date,mathlagdate,day))=0)

UNION ALL
(select *,if(mathlagdate is null, 0,date_diff(sent_date,mathlagdate,day)) hindi_date_difference,
from lag_dates_math
where if(mathlagdate is null, 0,date_diff(sent_date,mathlagdate,day))>=25)
order by parentid  desc)


 ,math_worksheet as (select *, row_number() over(partition by parentid order by sent_date asc)rn
from mathdata
order by parentid asc,rn asc)


,pulse_math as (

Select 
cohort,
"Math 1st Worksheet" as tables,
count(distinct if(rn=1,a.parentid,null)) as round_1_result,
count(distinct if(rn=2,a.parentid,null)) as round_2_result,
count(distinct if(rn=3,a.parentid,null)) as round_3_result,
count(distinct if(rn=4,a.parentid,null)) as round_4_result,
count(distinct if(rn=5,a.parentid,null)) as round_5_result,
count(distinct if(rn=6,a.parentid,null)) as round_6_result
-- count(distinct if(rn=7,a.parentid,null)) as round_7_result
from math_worksheet a
inner join ${ref("impact_evaluation_main_data")} ie_main
on a.parentid=ie_main.parentid
-- where last_message_status not like 'failed'
group by 1
)

----------------------------------------------------------------------
-- MTP CALLS
----------------------------------------------------------------------

, lag_dates_mtp as (
  select 
  parentid,
  dateOfAssessment,
  lag(dateOfAssessment) over(partition by parentid order by dateOfAssessment) as assessmentlagdate
  from assessments
  order by parentid asc, dateOfAssessment asc,assessmentlagdate asc
)

,resultData_mtp as ((select *,if(assessmentlagdate is null, 0,date_diff(dateOfAssessment,assessmentlagdate,day)) assessmentdateDifference,
from lag_dates_mtp
where if(assessmentlagdate is null, 0,date_diff(dateOfAssessment,assessmentlagdate,day))=0)

UNION ALL
(select *,if(assessmentlagdate is null, 0,date_diff(dateOfAssessment,assessmentlagdate,day)) assessmentdateDifference,
from lag_dates_mtp
where if(assessmentlagdate is null, 0,date_diff(dateOfAssessment,assessmentlagdate,day))>=25)
order by parentid  desc)


 ,result_mtp as (select *, row_number() over(partition by parentid order by dateOfAssessment asc)rn
from resultData_mtp
order by parentid asc,rn asc) -- using for the assessment data also










,mtp_assessement_wise as (
select 
parentid,
MAX(IF(rn = 1, dateOfAssessment, NULL)) AS assessment_1,
  MAX(IF(rn = 2, dateOfAssessment, NULL)) AS assessment_2,
  MAX(IF(rn = 3, dateOfAssessment, NULL)) AS assessment_3,
  MAX(IF(rn = 4, dateOfAssessment, NULL)) AS assessment_4,
  MAX(IF(rn = 5, dateOfAssessment, NULL)) AS assessment_5,
  MAX(IF(rn = 6, dateOfAssessment, NULL)) AS assessment_6,
  MAX(IF(rn = 7, dateOfAssessment, NULL)) AS assessment_7

from result_mtp
group by 1
)

,mtp_final as (
select
maw.parentid,
cohort,
max(
if(assessment_1 is not null,
if(date(mtp.inserted_at)>assessment_1 and date(mtp.inserted_at)<ifnull(assessment_2,'2026-12-01'),mtp.parentid,null) 
,null)) as iteration_1,

max(if(assessment_2 is not null,
if(date(mtp.inserted_at)>assessment_2 and date(mtp.inserted_at)<ifnull(assessment_3,'2026-12-01'),mtp.parentid,null)
,null )) as iteration_2,

max(if(assessment_3 is not null,
if(date(mtp.inserted_at)>assessment_3 and date(mtp.inserted_at)<ifnull(assessment_4,'2026-12-01'),mtp.parentid,null)
,null )) as iteration_3,

max(if(assessment_4 is not null,
if(date(mtp.inserted_at)>assessment_4 and date(mtp.inserted_at)<ifnull(assessment_5,'2026-12-01'),mtp.parentid,null)
,null )) as iteration_4,

max(if(assessment_5 is not null,
if(date(mtp.inserted_at)>assessment_5 and date(mtp.inserted_at)<ifnull(assessment_6,'2026-12-01'),mtp.parentid,null)
,null )) as iteration_5,


max(if(assessment_6 is not null,
if(date(mtp.inserted_at)>assessment_6 and date(mtp.inserted_at)<ifnull(assessment_7,'2026-12-01'),mtp.parentid,null)
,null )) as iteration_6,



from mtp_assessement_wise maw
left join ${ref("mtp_calls")} mtp
on maw.parentid=safe_cast(mtp.parentid as int64)
left join ${ref("impact_evaluation_main_data")} ie_main
on maw.parentid=ie_main.parentid
group by 1,2
)

------------------------------------------
-- ASSESSMENT TAKEN
-------------------------------------------

,assessment_taken as(
  select 
cohort,
"Assessment Taken" as sourcetab,
count(distinct if(rn=1,rm.parentid,null)) as round_1_assessment,
count(distinct if(rn=2,rm.parentid,null)) as round_2_assessment,
count(distinct if(rn=3,rm.parentid,null)) as round_3_assessment,
count(distinct if(rn=4,rm.parentid,null)) as round_4_assessment,
count(distinct if(rn=5,rm.parentid,null)) as round_5_assessment,
count(distinct if(rn=6,rm.parentid,null)) as round_6_assessment

from result_mtp rm
left join ${ref("impact_evaluation_main_data")} ie_main
on rm.parentid=ie_main.parentid
group by 1
)

, pulse_mtp as (
select
cohort,
"MTP Attempted" as stable,
count(distinct iteration_1) as r1_mtp,
count(distinct iteration_2) as r2_mtp,
count(distinct iteration_3) as r3_mtp,
count(distinct iteration_4) as r4_mtp,
count(distinct iteration_5) as r5_mtp,
count(distinct iteration_6) as r6_mtp
from mtp_final
group by 1
)

------------------------------------------------------------------------------------------------------
-- FLN ACHIEVED
------------------------------------------------------------------------------------------------------

, users as (
  select
  parentid,
  ie.ieid as childid,
  cohort,
  OptedOutStatus,
  ie.FLNStatus,
  date(ie.FLNAchievedDate) as fln_achieve_date,
  date(OptedOutDateTime) as opt_out_date
  from ${ref("impact_evaluation_main_data")} ie_main
  inner join ${ref("User")} u
  on u.userid=ie_main.parentid
  inner join ${ref("IE")}  ie
  on ie.OnBoardedUserId=u.userid
)
, FLN_ACHIEVE AS (
  SELECT 
  cohort,
  if(maw.assessment_1 is not null and  maw.assessment_1 =u.fln_achieve_date,u.parentid,null) as itr_1,
  if(maw.assessment_2 is not null and maw.assessment_2 =u.fln_achieve_date,u.parentid,null) as itr_2,
  if(maw.assessment_3 is not null and maw.assessment_3 =u.fln_achieve_date,u.parentid,null) as itr_3,
  if(maw.assessment_4 is not null and maw.assessment_4 =u.fln_achieve_date,u.parentid,null) as itr_4,
  if(maw.assessment_5 is not null and maw.assessment_5 =u.fln_achieve_date,u.parentid,null) as itr_5,
  if(maw.assessment_6 is not null and maw.assessment_6 =u.fln_achieve_date,u.parentid,null) as itr_6
  FROM users u
  left join mtp_assessement_wise maw
  on u.parentid=maw.parentid
  where u.fln_achieve_date is not null
)
, pulse_fln_achieve as (
  select
  cohort, 
  "FLN Achieved" as source_table,
  count(distinct itr_1) as iteration_1,
  count(distinct itr_2) as iteration_2,
  count(distinct itr_3) as iteration_3,
  count(distinct itr_4) as iteration_4,
  count(distinct itr_5) as iteration_5,
  count(distinct itr_6) as iteration_6
  from fln_achieve
  group by 1
)
---------------------------------------------------------------------------------
-- OPT OUT
---------------------------------------------------------------------------------

,opt_out as (
select 
cohort,
if(opt_out_date  <= ifnull(maw.assessment_1,'2027-01-01'),u.parentid,null ) as itr_1,
if(maw.assessment_1 is not null   and opt_out_date>maw.assessment_1 and opt_out_date <= ifnull(maw.assessment_2,'2027-01-01'),u.parentid,null ) as itr_2,
if(maw.assessment_2 is not null   and opt_out_date>maw.assessment_2 and opt_out_date <= ifnull(maw.assessment_3,'2027-01-01'),u.parentid,null ) as itr_3,
if(maw.assessment_3 is not null   and opt_out_date>maw.assessment_3 and opt_out_date <= ifnull(maw.assessment_4,'2027-01-01'),u.parentid,null ) as itr_4,
if(maw.assessment_4 is not null   and opt_out_date>maw.assessment_4 and opt_out_date <= ifnull(maw.assessment_5,'2027-01-01'),u.parentid,null ) as itr_5,
if(maw.assessment_5 is not null   and opt_out_date>maw.assessment_5 and opt_out_date <= ifnull(maw.assessment_6,'2027-01-01'),u.parentid,null ) as itr_6



from users u
left join mtp_assessement_wise maw
on u.parentid=maw.parentid

where opt_out_date is not null


)
, pulse_opt_out as (
  select
  cohort,
  "Opt Out" as source_table,
  count(distinct itr_1) as iteration_1,
  count(distinct itr_2) as iteration_2,
  count(distinct itr_3) as iteration_3,
  count(distinct itr_4) as iteration_4,
  count(distinct itr_5) as iteration_5,
  count(distinct itr_6) as iteration_6
  
  from opt_out 
  group by 1
)

----------------------------------------------------------------------------
-- 19th day message template
----------------------------------------------------------------------------
, pulse_message_template as (

  select 
  cohort,
  "19th Day message" as source_Table,
  count(distinct ie_main.parentid) as template_sent_1,
  0 as temp2,
  0 as temp3,
  0 as temp4,
  0 as temp5,
  0 as temp6
  from ${ref("allPhoneNumberWithPid")} p
  inner join ${ref("impact_evaluation_main_data")} ie_main
  on ie_main.parentid=p.rosterparentid
  inner join (select * from ${ref("IE_template_sent")}  where template_name in ('ie_calling_number_info2','ie_calling_number_info4')   and last_message_status not like 'failed'    )ts
  on ts.phone_number=p.number
group by 1



)


-----------------------------------------------------------------------
-- SCHEDULED TILL NOW
-----------------------------------------------------------------------
,  pulse_schedule_calls as (
SELECT
  cohort,
"Call Schedule Till Now" as source_table,
count(distinct if(round=1,fr.parentid,null)) as round_1,
count(distinct if(round=2,fr.parentid,null)) as round_2,
count(distinct if(round=3,fr.parentid,null)) as round_3,
count(distinct if(round=4,fr.parentid,null)) as round_4,
count(distinct if(round=5,fr.parentid,null)) as round_5,
count(distinct if(round=6,fr.parentid,null)) as round_6

-- fr.parentid,
-- cohort,
-- round as rn,

FROM ${ref("futureRoster")} FR
inner join  ${ref("impact_evaluation_main_data")} m
on fr.parentid=m.parentid
where CallDate <current_date("Asia/Kolkata")
group by all
)
-- ,pulse_schedule_calls as (
--   select
--   cohort,
-- "Schedule Till Now" as source_table,
-- count(distinct if(rn=1,a.parentid,null)) as round_1,
-- count(distinct if(rn=2,a.parentid,null)) as round_2,
-- count(distinct if(rn=3,a.parentid,null)) as round_3,
-- count(distinct if(rn=4,a.parentid,null)) as round_4,
-- count(distinct if(rn=5,a.parentid,null)) as round_5,
-- count(distinct if(rn=6,a.parentid,null)) as round_6

--  from schedule_calls a
--  group by all
-- )
---------------------------------------
-- UNIQUE DIAL
---------------------------------------
, pulse_roster_details as (
select
cohort,
"Unique Dialed" as source_table,
count(distinct if(round=1,a.parentid,null)) as round_1,
count(distinct if(round=2,a.parentid,null)) as round_2,
count(distinct if(round=3,a.parentid,null)) as round_3,
count(distinct if(round=4,a.parentid,null)) as round_4,
count(distinct if(round=5,a.parentid,null)) as round_5,
count(distinct if(round=6,a.parentid,null)) as round_6

from ${ref("roster")} a
inner join ${ref("impact_evaluation_main_data")} m
on m.parentid=a.parentid
where date(CallStartDateTime) between '2025-04-01' and '2026-12-01'
group by all
)

select *, 1 as ordernum
from pulse_general_activity_treatment


union all

select *, 2 as ordernum
from pulse_general_activity_control
union all
select *,3 as ordernum
from pulse_message_template
union all
select * ,4 as ordernum 
from pulse_schedule_calls
union all
select *,5 as ordernum
from pulse_roster_details
union all

select *, 6 as ordernum
from pulse_call_reslove
union all

SELECT *, 7 AS ORDERNUM
FROM assessment_taken
UNION ALL

select *, 8 as ordernum
from pulse_result_shared
union all

select * ,9 as ordernum
from pulse_fln_achieve
union all

select *,10 as ordernum
from pulse_highest_level_hindi
union all
select *,11 as ordernum 
from pulse_highest_level_math
union all

select *,12 as ordernum 
from pulse_opt_out
union all



select *, 13 as ordernum
from pulse_hindi
union all

select *, 14 as ordernum
from pulse_math
union all

select *, 15 as ordernum
from pulse_mtp
order by ordernum