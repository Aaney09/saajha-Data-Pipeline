config {
    type: "table",
    tags: ["General_activity"]
}
with _34_status as (
  SELECT
  DISTINCT
  message_uuid,
  status as last_message_status,
    datetime_add(updated_at, interval 330 minute)updated_status_at,
  
  json_value(replace(replace( errors,"[",""),']',""),"$.title")title,
  json_value(replace(replace( errors,"[",""),']',""),"$.code")code,


  



FROM
  ${ref("911171817034","statuses")}
-- where date(datetime_add(updated_at, interval 330 minute))<current_date("Asia/Kolkata")
qualify row_number() over(partition by message_uuid order by updated_at desc)=1
)
,template_sent as (
  SELECT distinct 
    safe_cast(trim(addressees,'""[]+') as int64) phone_number,
    -- id,
    -- uuid, 
    -- chat_id,
    -- json_value(author,"$.id")flow_id,
    json_value(author,"$.name")flow_name,
    json_value(author,"$.type")flow_type,
    json_value(template,"$.name")template_name, 
    -- template template_meta_data, 
    -- rendered_content as message_content,
    last_message_status,
    title as error_reason,
    code as error_code,
    datetime_add(inserted_at, Interval 330 minute)sent_at,
    updated_status_at, 
    911171817034 saajha_whatsapp_number,
    "IE" wa_number_purpose,
    external_id,
from ${ref("911171817034","messages")}
left join _34_status
on uuid = message_uuid
where message_type = "template" 
qualify row_number()over(partition by uuid order by updated_at desc)=1
)
, ie_pilot_table as (
  select 
   cohort,
  phone_lookup as  phoneno,
  -- "2028-10-10" as activity_date,
  Assignment AS `GROUP`,

  -- *
  activity_date
  from `impact_evaluation.ie_main_randomized_data` -- change to main
  left join unnest( -- UNCOMMENT THIS
    case when cohort=1 then ['2025-12-09','2026-01-09','2026-02-09','2026-03-09','2026-04-09','2026-05-09','2026-06-09']
    when cohort=2 then ['2025-12-14','2026-01-14','2026-02-14','2026-03-14','2026-04-14','2026-05-14']
    when cohort=3 then ["2025-12-21","2026-01-21","2026-02-21","2026-03-21","2026-04-21","2026-05-21"]
    when cohort=4 then ["2025-12-28","2026-01-28","2026-02-28","2026-03-28","2026-04-28","2026-05-28"]
    when cohort=5 then ['2026-01-04','2026-02-04','2026-03-04','2026-04-04','2026-05-04','2026-06-04'] 
  --   else []
    end) as activity_date 
  
  -- where phoneno not in (917979058086,919315661819,918218140968  ) -- UNCOMMENT THIS
)

, first_status as (
  select ts.*
  from template_sent ts
  where template_name='ie_onb_activity_v2'

  qualify row_number() over(partition by phone_number,date(sent_at) order by sent_At asc)=1
)
,
last_status as (
  select *
  from  template_sent ts
  where template_name='ie_onb_activity_v2'
  qualify row_number() over(partition by phone_number,date(sent_at) order by sent_At desc)=1
)

, first_message_full_status as (
select
iep.Cohort,
iep.group,
iep.phoneNo as phone_numbers_to_be_sent,
iep.activity_date as general_activity_date,
fs.sent_at as first_sent_at,


if(fs.phone_number is not null,fs.phone_number,null) as phone_numbers_actually_sent,
if(fs.phone_number is not null and fs.last_message_status not like 'failed',fs.phone_number,null) as phone_numbers_successfully_sent,
if( fs.last_message_status  like 'failed',fs.phone_number,null) as meta_failure_numbers,
if(fs.phone_number is null,iep.phoneno,null) as turn_failure_number,
if(fs.error_code='131050',fs.phone_number,null) as code_050_User_has_stopped_reciept_of_marketing_messages,
if(fs.error_code='131049',fs.phone_number,null) as code_049_Meta_chose_not_to_deliver,
if(fs.error_code='131026',fs.phone_number,null) as code_026_Message_Undeliverable,
if(fs.error_code='131000',fs.phone_number,null) as code_000_Something_went_wrong,
if(fs.error_code='130472',fs.phone_number,null) as code_472_User_number_is_part_of_an_experiment
-- if(fs.error_code='131050',fs.phone_number,null) as


from ie_pilot_table iep
left join first_status fs
on fs.phone_number=iep.phoneno
and date(fs.sent_at)=date(iep.activity_date)
where date(iep.activity_date)<current_date("Asia/Kolkata")+1

)
, second_message_full_status as (
select
fmfs.phone_numbers_to_be_sent as numbers_to_be_triggered_again,
fmfs.general_Activity_date,
ts.sent_at as second_sent_time,
-- ts.phone_number,
if(ts.phone_number is null,fmfs.phone_numbers_to_be_sent,null) as turn_failed_second_time,
if(ts.last_message_status like 'failed',fmfs.phone_numbers_to_be_sent,null) as meta_failed_second_time,
if(ts.last_message_status not like 'failed',fmfs.phone_numbers_to_be_sent,null) as sent_successfully_second_time



from  first_message_full_status fmfs
left join  last_status ts  -- yaha pe last status use karlo
on fmfs.phone_numbers_to_be_sent =ts.phone_number
and  date(fmfs.first_sent_at)=date(ts.sent_at)
and fmfs.first_sent_at<ts.sent_at --- joined here on date also to taken only that day status
where 1=1
--  and fmfs.first_sent_at<ts.sent_at
and (
fmfs.turn_failure_number is not null
or fmfs.code_049_Meta_chose_not_to_deliver is not null
)
)

-- select * from second_message_full_status
select
distinct
fsfp.phone_numbers_to_be_sent,
fsfp.Cohort,
fsfp.group,
fsfp.general_activity_date,
date(fsfp.first_sent_at) as template_sent_on,
fsfp.phone_numbers_successfully_sent,
fsfp.meta_failure_numbers,
fsfp.turn_failure_number,
fsfp.code_050_User_has_stopped_reciept_of_marketing_messages,
fsfp.code_049_Meta_chose_not_to_deliver,
fsfp.code_026_Message_Undeliverable,
fsfp.code_000_Something_went_wrong,
fsfp.code_472_User_number_is_part_of_an_experiment,
--------------------------------------------------------------------
-- TRIGGERED AGAIN
-----------------------------------------------------------------------
smfs.numbers_to_be_triggered_again,
smfs.turn_failed_second_time,
smfs.meta_failed_second_time,
smfs.sent_successfully_second_time




from first_message_full_status fsfp

left join second_message_full_status smfs
on fsfp.phone_numbers_to_be_sent=smfs.numbers_to_be_triggered_again
and fsfp.general_activity_date=smfs.general_activity_date


-- left join last_status ls
-- on fsfp.phone_numbers_to_be_sent=ls.phone_number


-- on iep.phoneno=fsfp.phone_numbers_to_be_sent



-- on ts.phone_number=iep.phoneno
-- where template_name='ie_onb_activity_v2' 









