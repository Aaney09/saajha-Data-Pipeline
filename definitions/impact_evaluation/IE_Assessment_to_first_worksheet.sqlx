config {
    type: "table",
    tags: "IE",
    description: "IE result failure tracking for the assessed children"
    }


with 
hindi as (select distinct AssesseeActorId,Date(AssessmentTakenOn)dateOfAssessment,if(Level= "BEGINNER",0,safe_cast(regexp_extract(Level,r'\d') as int64)) as hindiLevel
from ${ref("assessment")}
where QuestionText like "%Ask%" and AssessmentId<>6
qualify row_number() over(partition by AssesseeActorId,date(AssessmentTakenOn) order by AssessmentTakenOn desc)=1
)
, math as (select distinct AssesseeActorId,Date(AssessmentTakenOn)dateOfAssessment, if(Level= "BEGINNER",0,safe_cast(regexp_extract(Level,r'\d') as int64)) as mathlevel
from ${ref("assessment")}
where QuestionText not like  "%Ask%" and AssessmentId <> 6
qualify row_number() over(partition by AssesseeActorId,date(AssessmentTakenOn) order by AssessmentTakenOn desc)=1
)

, childDetails as (select 
distinct 
ie.IEId as childid, ie.OnBoardedUserId as parentid,m.cohort,ie.ProjectId as ProjectId,
safe_cast(regexp_extract(Education,r'\d+') as int64)as childClass,Education
from ${ref("IE")} ie
left join   ${ref("impact_evaluation_main_data")} m
on m.parentid=ie.OnBoardedUserId
where  ie.projectid=1103912
)

, assessments as (
  select *, dateOfAssessment+1 as hindi_content_to_send_on,dateOfAssessment+2 as math_content_to_send_on,
  case  
when c.childClass = 1 and mathLevel>=2 then TRUE
when c.childClass = 2 and mathLevel>=3 then TRUE
when c.childClass >=3 and mathLevel>=4 then TRUE
Else false
end mathFLnAchievedClassWise,
case  
when c.childClass = 1 and hindiLevel>=3 then TRUE
when c.childClass >=2 and hindiLevel>=4 then TRUE
Else false
end hindiFLnAchievedClassWise
from hindi h
inner join math m
using(assesseeActorID,dateOfAssessment)
inner join childDetails c
on assesseeActorID=childid
where m.dateOfAssessment <= current_date("Asia/Kolkata")-3
)


select
distinct 
a.dateOfAssessment,
a.cohort,
rf.* except(dateOfAssessment,cohort),
mw.* except(dateOfAssessment,ChildiAssessed,ParentIdAssessed,cohort),
hw.* except(dateOfAssessment,ChildiAssessed,ParentIdAssessed,cohort)
from assessments a
left join ${ref("IE_result_failure_tracking")} rf
on a.dateOfAssessment=rf.dateOfAssessment
and a.cohort=rf.cohort

left join ${ref("IE_math_assessment_to_first_worksheet")} mw
on a.dateOfAssessment=mw.dateOfAssessment
and a.cohort=mw.cohort

left join ${ref("IE_hindi_assessment_to_first_worksheet")} hw
on a.dateOfAssessment=hw.dateOfAssessment
and a.cohort=hw.cohort
order by 1 desc
